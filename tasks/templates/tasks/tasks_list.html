{% extends "tasks/base.html" %}
{% load static %}
{% block custom_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.css">
{% endblock custom_css %}
{% block content %}
    <div class="container py-4">
        <div class="row justify-content-center">
            <div id="create-form" method="POST" class="task-view" autocomplete="off">
                <div class="form-header">
                    <h1>Your Tasks List</h1>
                    <div class="row justify-content-center mb-3">
                        <a class="w-auto" href="{% url 'create_task' %}"><h2 class="w-auto mb-1 py-3 create-task-link"><span>Create Task</span></h2></a>
                        <a class="w-auto" href="{% url 'create_task' %}"><button class="plus-btn" type="button"><i class="fa-solid fa-plus"></i></button></a>
                    </div>
                    <form method="GET" >
                        <div class="d-flex justify-content-center">
                            <div class="col-md-6 col-7 d-flex justify-content-end">
                                <input class="search-input py-2 px-4" type="text" name="search-area" value="{{search_input}}">  <!-- value = search_input so that the page doesn't refresh-->
                            </div>
                            <div class="col-md-6 col-5">
                                <button class="search-btn" type="submit">Search Task</button>
                            </div>
                        </div>
                    </form>
                    
                </div>

                <div class="inner-form">
                    <!--<div class="row justify-content-end">
                        <div class="fitered-task-text col-8">
                            <p class="mb-1"><span>Filter Tasks</span></p>
                        </div>
                    </div>-->
                    <div class="row justify-content-end">
                        <form method="GET" action="">
                            <div class="row">
                                <!--<div>
                                    {{ filterset.form }}
                                    <button class="filter-btn" type="submit">Apply Filters</button>
                                </div>-->
                                <!--<div class="filter_field col-md-4 col-12">
                                    <input class="signup__input" type="text" id="{{ filterset.form.title__icontains.id }}" name="{{ filterset.form.title__icontains.name }}">
                                    <label class="signup__label" for="{{ filterset.form.title__icontains.id }}">Title:</label>
                                </div>-->

                                <!-- Creation Date Filter -->
                                <div class="filter_field col-md-3 col-12 px-2">
                                    <input class="signup__input" type="date" id="{{ filterset.form.creation_date.id }}" name="{{ filterset.form.creation_date.name }}">
                                    <label class="signup__label" for="{{ filterset.form.creation_date.id }}">Creation Date:</label>
                                </div>

                                <!-- Due Date Filter -->
                                <div class="filter_field col-md-3 col-12 px-2">
                                    <input class="signup__input" type="date" id="{{ filterset.form.due_date.id }}" name="{{ filterset.form.due_date.name }}">
                                    <label class="signup__label" for="{{ filterset.form.due_date.id }}">Due Date:</label>
                                </div>

                                <!-- Priority Filter -->
                                <div class="filter_field col-md-3 col-12 px-2">
                                    <label class="" for="{{ filterset.form.priority.id }}">Priority:</label>
                                    <!--<select id="{{ filterset.form.priority.id }}" name="{{ filterset.form.priority.name }}" class="custom-select-class">
                                        <option value="" {% if not filterset.form.priority.value %}selected{% endif %}>{{ filterset.form.priority.empty_label }}</option>
                                        {% for choice in filterset.form.priority.field.choices %}
                                            <option value="{{ choice.0 }}" {% if filterset.form.priority.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                        {% endfor %}
                                    </select>-->

                                    <div class="select_mate" data-mate-select="dropdown-active" >
                                        <select class="" name="{{ filterset.form.priority.name }}" onchange="" onclick="return false;" id="{{ filterset.form.priority.id }}">
                                            {% comment %} <option value="">Filter Priority</option> {% endcomment %}
                                            {% for choice in filterset.form.priority.field.choices %}
                                                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                            {% endfor %}
                                        </select>
                                        <p class="selecionado_opcion"  onclick="open_select(this)" ></p><span onclick="open_select(this)" class="icon_select_mate" ><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z"/>
                                            <path d="M0-.75h24v24H0z" fill="none"/>
                                        </svg></span>
                                        <div class="cont_list_select_mate">
                                        <ul class="cont_select_int">  </ul> 
                                        </div>
                                    </div>
                                </div>

                                 <!-- Is Complete Filter -->
                                <div class=" col-md-3 col-12 px-2">
                                    <label class="" for="{{ filterset.form.is_complete.id }}">Is Complete:</label>
                                    <!--<select id="{{ filterset.form.priority.id }}" name="{{ filterset.form.priority.name }}" class="custom-select-class">
                                        <option value="" {% if not filterset.form.priority.value %}selected{% endif %}>{{ filterset.form.priority.empty_label }}</option>
                                        {% for choice in filterset.form.priority.field.choices %}
                                            <option value="{{ choice.0 }}" {% if filterset.form.priority.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                        {% endfor %}
                                    </select>-->

                                    <div class="select_mate" data-mate-select="dropdown-active" >
                                        <select class="" name="{{ filterset.form.is_complete.name }}" onchange="" onclick="return false;" id="{{ filterset.form.is_complete.id }}">
                                            {% comment %} <option value="">f</option> {% endcomment %}
                                            {% for choice in filterset.form.is_complete.field.choices %}
                                                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                            {% endfor %}
                                        </select>
                                        <p class="selecionado_opcion"  onclick="open_select(this)" ></p><span onclick="open_select(this)" class="icon_select_mate" ><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z"/>
                                            <path d="M0-.75h24v24H0z" fill="none"/>
                                        </svg></span>
                                        <div class="cont_list_select_mate">
                                        <ul class="cont_select_int">  </ul> 
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-center my-3">
                                <button class="filter-btn" type="submit">Apply Filters</button>
                            </div>
                        </form>
                        <!--<div class="fiter-div col-8 mb-3">
                            
                            <label for="filter_name">Filter Tasks by:</label>
                            <div class="select_mate" data-mate-select="dropdown-active" >
                                <select name="filter_name" onchange="filterTasksChange()" onclick="return false;" id="filter_name">
                                    <option value=""  >Filter Tasks</option>
                                    {% for filter_name in filter_options %}
                                        <option value="{{ filter_name }}">{{ filter_name }}</option>
                                    {% endfor %}
                                </select>
                                <p class="selecionado_opcion" onchange=""  onclick="open_select(this)" ></p><span class="icon_select_mate" ><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z"/>
                                    <path d="M0-.75h24v24H0z" fill="none"/>
                                </svg></span>
                                <div class="cont_list_select_mate">
                                <ul class="cont_select_int">  </ul> 
                                </div>
                            </div>
                        </div>-->
                    </div>
                    <form method="POST" id="task-list-form" action="">
                        {% csrf_token %}
                        <div id="tasks-list" class="tasks-list">
                                {% for task in tasks %}
                                <div class="card mb-3">
                                    <div class="d-flex">
                                        <!--<div class="completed-div p-3">
                                            <i class="fa-solid fa-check"></i>
                                        </div>-->
                                        <div class="completed-div checkbox-wrapper">
                                            <input type="checkbox" id="task_{{task.id}}" data-task-id="{{task.id}}" data-completed="{{task.completed}}" {% if task.is_complete %}checked="checked"{% endif %}>
                                            <label class="completed-label" for="task_{{task.id}}"><i class="fa-solid fa-check"></i></label>
                                        </div>
                                        <div class="task-name-div">
                                            <a class="task-link" href="{% url 'task_detail' task.id %}">
                                                <div class="task-name-div p-3">
                                                    <p><span>{{ task.title }}</span></p>
                                                </div>
                                            </a>
                                        </div>
                                        <div class="task-action-div ps-3">
                                            <div class="eye-div d-flex justify-content-center">
                                                <a class="text-decoration-none" href="{% url 'task_detail' task.id %}"><i class="fa-solid fa-eye"></i></a>
                                            </div>
                                            <div class="trash-div d-flex justify-content-center" data-task-id="{{task.id}}">
                                                <i class="fa-solid fa-trash"></i>
                                            </div>
                                            
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="popup-container" class="popup-container">
        <div class="popup d-flex justify-content-center">
            <img src="{% static 'img/404-tick.png' %}" alt="" class="success-tick">
            <div class="registration-success-div px-3">
                <p class="mb-2 text-center"><span class="response-message text-center"></span></p>
            </div>
            <span class="close-icon"><i class="fa-solid fa-xmark fa-xl" style="color: #dedede;"></i></span>
        </div>
    </div>

    <form method="POST" action="" id="delete-form">
        {% csrf_token %}
        <div id="delete-popup-container" class="delete-popup-container">
            <div class="delete-popup d-flex justify-content-center">
                <img src="{% static 'img/delete.png' %}" alt="" class="success-tick">
                
                    <div class="registration-success-div px-3">
                        <p class="mb-4 text-center"><span class="delete-response-message text-center">Are you sure?</span></p>
                        <div id="delete-task-btn-div" class="delete-task-btn-div col-6 d-flex justify-content-center w-auto">
                            <button class="search-btn delete-task-btn px-3" type="submit">Delete Task</button>
                        </div>
                    </div>
                <span class="close-icon delete-close-icon"><i class="fa-solid fa-xmark fa-xl" style="color: #dedede;"></i></span>
            </div>
        </div>
    </form>
{% endblock content %}

{% block custom_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="{% static "js/select_dropdown.js" %}"></script>
<script>
    $(document).ready(function(){
        $('.datepicker').datepicker({
            format: 'yyyy-mm-dd',
            todayHighlight: true,
            toggleActive: true
        });

        // Function to send data to the server
        function updateTaskStatus(taskId, completed) {
            const url = '/update_task_status/' + taskId + '/';
            const data = { 'task_id': taskId, 'completed': completed };

            fetch(url, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Handle success, e.g., redirect to a new page
                    //window.location.href = '/success/';
                    console.log('data rec')
                    console.log('data.success: ', data.success)
                    $('#popup-container').addClass('show');
                    $('.response-message').text(data.success);

                    setTimeout(function(){
                        $('#popup-container').removeClass('show');
                        $('.response-message').text('');
                    }, 1000)
                } 
                else {
                    $('#error-message').text(data.message);
                }
            })
            .catch(error => {
                console.error('Network error:', error);
            });
        }

        // Function to send data to the server
        function deleteTask(taskId) {
            const url = '/delete_task/' + taskId + '/';
            const data = { 'task_id': taskId};

            fetch(url, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#delete-popup-container').removeClass('show');
                    $('#popup-container').addClass('show');
                    $('.response-message').text(data.success);

                    setTimeout(function(){
                        $('#popup-container').removeClass('show');
                        window.location.reload();
                    }, 1000)
                } 
                else {
                    $('#error-message').text(data.message);
                }
            })
            .catch(error => {
                console.error('Network error:', error);
            });
        }

        // Add event listener for checkbox change
        $('.checkbox-wrapper input[type="checkbox"]').on('change', function() {
            const taskId = $(this).data('task-id');
            const completed = this.checked;
            updateTaskStatus(taskId, completed);

        });

        $('.trash-div').on('click', function() {
            const taskId = $(this).data('task-id');
            //var delete
            console.log('taskId: ', taskId)
            $('#delete-popup-container').addClass('show');
            //updateTaskStatus(taskId, completed);

            $('#delete-form').on('submit', function(e){
                e.preventDefault();
                console.log('delete btn clicked')
                deleteTask(taskId)
            })

        });

        $('.close-icon').on('click', function(){
            $('#popup-container').removeClass('show');
        })

        $('.delete-close-icon').on('click', function(){
            $('#delete-popup-container').removeClass('show');
        })


        /*const fileInput = $('#photos');
        const thumbnailsContainer = $('.thumbnails');

        fileInput.on('change', function(event) {
            const files = event.target.files;

            $.each(files, function(index, file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                    const thumbnail = $('<img>');
                    thumbnail.addClass('thumbnail');
                    thumbnail.attr('src', e.target.result);
                    thumbnailsContainer.append(thumbnail);
                    };

                    reader.readAsDataURL(file);
                }
            });
        });

        $('#create-form').on('submit', function(event) {
            event.preventDefault();
            console.log('clicked')
    
            let task_name = $('#task_name').val();
            let due_date = $('#due_date').val();
            let priority = $('#priority').val();
            let description = $('#description').val();

            const fileInputs = $('input[type="file"]');
            let photos = []
            fileInputs.each(function() {
                const files = this.files;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log('Selected file:', file);
                    photos.push(file)
                    console.log('photos: ', photos)
                    // You can now do something with each selected file, like displaying a preview.
                }
            });
    
            let formData = new FormData(this);
            formData.append('photos: ', photos)

            for (const entry of formData.entries()) {
                console.log('Form Data: ')
                console.log(entry[0], entry[1]);
            }
    
            fetch('/save_task/', {
                method: 'POST',
                headers: {
                    'x-CSRFToken': '{{csrftoken}}'
                },
                body: formData,
                //credentials: 'same-origin',  // Include this if your Django project uses CSRF protection
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Handle success, e.g., redirect to a new page
                    //window.location.href = '/success/';
                    console.log('data.success: ', data.success)
                    $('#popup-container').addClass('show');

                    setTimeout(function(){
                        $('#popup-container').removeClass('show');
                    }, 1000)
                } 
                else {
                    $('#error-message').text(data.message);
                }
            })
            .catch(error => {
                $('#error-message').text('Error: ' + error.message);
            });
        });

        $('.close-icon').on('click', function(){
            $('#popup-container').removeClass('show');
        })*/
    });
</script>

<script>
        console.log('got it')
        function testselect(){
            var filterName = $('#filter_name').val();
            console.log('value changed to: ', filterName)
        }

        function filterTasksChange() {
            // Get the selected warehouse value
            console.log('source_warehouse')
            var filterName = $('#filter_name').val();
            console.log('value changed to: ', filterName)
            
            // Call the fetchData function with the selected value
            filterTasks(filterName);
        }

        function filterTasks(filterName){
            const url = '/filter_tasks/?filter_name=' + filterName;
            fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok (${response.status} ${response.statusText})`);
                }
                return response.json(); // Assuming the response is in JSON format
            })
            .then(data => {
                if (data) {
                    console.log('data: ', data)
                    $('#task-list').html(data.tasks);
                }
                else {
                    // Handle server-side errors or display a message
                    console.error('Server response error:', data.message || 'Unknown error');
                }
            })
            .catch(error => {
                // Handle network or other errors
                console.error('Fetch error:', error.message || 'Unknown error');
            });
        }
        $('#task_name').change(testselect);
    
</script>
{% endblock custom_js %}